<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Cadastro - Quest√µes de Avia√ß√£o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --verde: #2f4f2f;
      --verde-claro: #3f6f3f;
      --cinza-fundo: #f5f6f7;
      --card-bg: #ffffff;
      --card-borda: #e5e7eb;
      --erro: #b00020;
      --ok: #1e7f4f;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--cinza-fundo);
      color: #1f2937;
      position: relative;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: url('background.jpeg') no-repeat center center / cover;
      opacity: .30;
      z-index: -1;
    }
    .page {
      min-height: 100%;
      display: grid;
      place-items: center;
      padding: 24px;
    }
    .card {
      width: 100%;
      max-width: 500px;
      background: var(--card-bg);
      border: 1px solid var(--card-borda);
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.06);
      padding: 28px 28px 24px;
      backdrop-filter: saturate(140%) blur(4px);
    }
    h2 {
      margin: 0 0 14px;
      color: var(--verde);
      font-size: 1.35rem;
      text-align: center;
    }
    label {
      font-weight: 600;
      font-size: .95rem;
      display: block;
      margin-top: 10px;
      margin-bottom: 6px;
    }
    input, select {
      width: 90%;
      margin: 0 auto;
      display: block;
      padding: 11px 12px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 1rem;
      background: #fff;
      outline: none;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    input:focus, select:focus {
      border-color: #86b4a1;
      box-shadow: 0 0 0 3px rgba(47,79,47,.15);
    }
    .btn {
      width: 90%;
      margin: 14px auto 0;
      display: block;
      padding: 12px 16px;
      border-radius: 999px;
      border: none;
      background: var(--verde);
      color: #fff;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: transform .15s ease, background-color .15s ease, opacity .15s ease;
      box-shadow: 0 2px 6px rgba(0,0,0,.12);
    }
    .btn:hover { transform: translateY(-1px); background: var(--verde-claro); }
    .btn:disabled { opacity: .6; cursor: not-allowed; transform: none; }

    .mensagem {
      width: 90%;
      margin: 10px auto 0;
      font-size: .95rem;
      line-height: 1.35;
    }
    .mensagem.erro { color: var(--erro); }
    .mensagem.ok { color: var(--ok); }

    .voltar {
      display: block;
      text-align: center;
      margin-top: 10px;
      color: var(--verde);
      text-decoration: none;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="card">
      <h2>Cadastro de Novo Usu√°rio</h2>
      <form id="cadastro-form" novalidate>
        <label for="nome">Nome completo</label>
        <input type="text" id="nome" required>

        <label for="cpf">CPF (somente n√∫meros)</label>
        <input type="text" id="cpf" inputmode="numeric" required>

        <label for="email">Email</label>
        <input type="email" id="email" required>

        <label for="telefone">Telefone com DDD</label>
        <input type="tel" id="telefone" inputmode="numeric" required>

        <label for="senha">Senha</label>
        <input type="password" id="senha" required>

        <label for="confirmarSenha">Confirme sua senha</label>
        <input type="password" id="confirmarSenha" required>

        <label for="objetivo">Qual √© seu objetivo?</label>
        <select id="objetivo">
          <option>Piloto Privado (PP)</option>
          <option>Piloto Comercial (PC)</option>
          <option>Comiss√°rio (CMS)</option>
          <option>Mec√¢nico de Manuten√ß√£o de Aeronaves (MMA)</option>
          <option>Outro</option>
        </select>

        <label for="fase">Em qual fase de estudo voc√™ est√°?</label>
        <select id="fase">
          <option>Fase Te√≥rica</option>
          <option>Fase Pr√°tica</option>
          <option>J√° sou habilitado</option>
          <option>Estou come√ßando agora</option>
        </select>

        <button id="btnCadastrar" type="submit" class="btn">Cadastrar</button>
        <div id="mensagem" class="mensagem" aria-live="polite"></div>
      </form>

      <a class="voltar" href="quiz.html">‚Üê Voltar para o login</a>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      deleteUser,
      signOut
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      serverTimestamp,
      getDoc
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCZcJS_AQYPWcYRsnoWljBgZRItBrCO9DE",
      authDomain: "quiz-aviacao.firebaseapp.com",
      projectId: "quiz-aviacao",
      storageBucket: "quiz-aviacao.appspot.com",
      messagingSenderId: "304277871974",
      appId: "1:304277871974:web:98ebb69afe488439d53ca7",
      measurementId: "G-B9NBQJD8KC"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // üîç UTM Parameter Capture
    // These helper functions extract UTM parameters from the query string.
    // If the parameter is not present, they return null.
    function getUTM(key) {
      const params = new URLSearchParams(window.location.search);
      return params.get(key) || null;
    }
    // Capture source (google, meta), campaign and keyword (for Google ads)
    const utm_source = getUTM('utm_source');
    const utm_campaign = getUTM('utm_campaign');
    const utm_term = getUTM('utm_term');

    const form = document.getElementById('cadastro-form');
    const btn = document.getElementById('btnCadastrar');
    const msg = document.getElementById('mensagem');

    function setMensagem(texto, tipo = "erro") {
      msg.textContent = texto;
      msg.className = `mensagem ${tipo}`;
    }

    const validarCPF = cpf => /^\d{11}$/.test(cpf);
    const validarTelefone = tel => /^\d{10,11}$/.test(tel);
    const validarEmail = em => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(em);

    // üîß Converte email para um ID seguro no Firestore
    function sanitizeEmail(email) {
      return email.replace(/\./g, '_').replace(/@/g, '_');
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      setMensagem("");
      btn.disabled = true;

      const nome = document.getElementById('nome').value.trim();
      const cpf = document.getElementById('cpf').value.trim();
      const email = document.getElementById('email').value.trim().toLowerCase();
      const emailId = sanitizeEmail(email);
      const telefone = document.getElementById('telefone').value.trim();
      const senha = document.getElementById('senha').value;
      const confirmarSenha = document.getElementById('confirmarSenha').value;
      const objetivo = document.getElementById('objetivo').value;
      const fase = document.getElementById('fase').value;

      if (!nome || !validarCPF(cpf) || !validarEmail(email) || !validarTelefone(telefone) || senha.length < 6 || senha !== confirmarSenha) {
        setMensagem("Preencha todos os campos corretamente.");
        btn.disabled = false;
        return;
      }

      let createdUser = null;
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, senha);
        createdUser = cred.user;

        const userDocRef = doc(db, "usuarios", emailId);
        let ativoInicial = false;

        const snap = await getDoc(userDocRef);
        if (snap.exists()) {
          const dados = snap.data();
          const expira = dados.expiraEm || dados.expira;
          if (dados.ativo === true && expira && new Date(expira.toDate ? expira.toDate() : expira) > new Date()) {
            ativoInicial = true;
          }
        }

        // üìù Assemble data for Firestore. Only add UTM fields if they exist.
        const docData = {
          uid: createdUser.uid,
          nome,
          cpf,
          telefone,
          email,
          objetivo,
          fase,
          ativo: ativoInicial,
          timestamp: serverTimestamp()
        };
        // Conditionally attach UTM information to the document
        if (utm_source) {
          docData.utm_source = utm_source;
        }
        if (utm_campaign) {
          docData.utm_campaign = utm_campaign;
        }
        if (utm_term) {
          docData.utm_term = utm_term;
        }
        await setDoc(userDocRef, docData, { merge: true });

        setMensagem("Usu√°rio cadastrado com sucesso! Fa√ßa login para continuar.", "ok");
        await signOut(auth);

        setTimeout(() => {
          window.location.href = "quiz.html";
        }, 2500);

      } catch (err) {
        console.error(err);
        // tenta apagar o usu√°rio criado, se chegou a criar
        try {
          if (createdUser) {
            await deleteUser(createdUser);
          }
        } catch (e) {
          console.error("Erro ao deletar usu√°rio criado:", e);
        }

        try {
          await signOut(auth);
        } catch (e) {
          console.error("Erro ao fazer signOut:", e);
        }

        // mostra o c√≥digo do erro na tela para a gente diagnosticar
        const codigo = err && err.code ? err.code : "";
        const mensagemDetalhe = err && err.message ? err.message : "";
        setMensagem(
          "Erro ao cadastrar. C√≥digo: " + codigo + (mensagemDetalhe ? " - " + mensagemDetalhe : ""),
          "erro"
        );
      }

      btn.disabled = false;
    });
  </script>
</body>
</html>
