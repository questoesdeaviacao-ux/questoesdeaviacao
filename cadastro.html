<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Cadastro - Questões de Aviação</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --verde: #2f4f2f;
      --verde-claro: #3f6f3f;
      --cinza-fundo: #f5f6f7;
      --card-bg: #ffffff;
      --card-borda: #e5e7eb;
      --erro: #b00020;
      --ok: #1e7f4f;
    }

    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--cinza-fundo);
      color: #1f2937;
      position: relative;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: url('background.jpeg') no-repeat center center / cover;
      opacity: .30;
      z-index: -1;
    }

    /* Centraliza vertical e horizontal */
    .page {
      min-height: 100%;
      display: grid;
      place-items: center;
      padding: 24px;
    }

    /* Cartão do formulário */
    .card {
      width: 100%;
      max-width: 500px;             /* um pouco maior */
      background: var(--card-bg);
      border: 1px solid var(--card-borda);
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.06);
      padding: 28px 28px 24px;      /* mais respiro */
      backdrop-filter: saturate(140%) blur(4px);
    }

    h2 {
      margin: 0 0 14px;
      color: var(--verde);
      font-size: 1.35rem;
      text-align: center;
    }

    label {
      font-weight: 600;
      font-size: .95rem;
      display: block;
      margin-top: 10px;
      margin-bottom: 6px;
    }

    input, select {
      width: 90%;                   /* campos mais estreitos */
      margin: 0 auto;               /* centraliza dentro do card */
      display: block;
      padding: 11px 12px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 1rem;
      background: #fff;
      outline: none;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    input:focus, select:focus {
      border-color: #86b4a1;
      box-shadow: 0 0 0 3px rgba(47,79,47,.15);
    }

    .btn {
      width: 90%;                   /* acompanha a largura dos inputs */
      margin: 14px auto 0;
      display: block;
      padding: 12px 16px;
      border-radius: 999px;
      border: none;
      background: var(--verde);
      color: #fff;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: transform .15s ease, background-color .15s ease, opacity .15s ease;
      box-shadow: 0 2px 6px rgba(0,0,0,.12);
    }
    .btn:hover { transform: translateY(-1px); background: var(--verde-claro); }
    .btn:disabled { opacity: .6; cursor: not-allowed; transform: none; }

    .mensagem {
      width: 90%;
      margin: 10px auto 0;
      font-size: .95rem;
      line-height: 1.35;
    }
    .mensagem.erro { color: var(--erro); }
    .mensagem.ok { color: var(--ok); }

    .voltar {
      display: block;
      text-align: center;
      margin-top: 10px;
      color: var(--verde);
      text-decoration: none;
      font-weight: 600;
    }
  </style>
</head>
<body>
  
  <div class="page">
    <div class="card">
      <h2>Cadastro de Novo Usuário</h2>
      <form id="cadastro-form" novalidate>
        <label for="nome">Nome completo</label>
        <input type="text" id="nome" placeholder="Ex.: Ana Silva" required>

        <label for="cpf">CPF (somente números)</label>
        <input type="text" id="cpf" inputmode="numeric" placeholder="Ex.: 12345678901" required>

        <label for="email">Email</label>
        <input type="email" id="email" placeholder="voce@exemplo.com" required>

        <label for="telefone">Telefone com DDD</label>
        <input type="tel" id="telefone" inputmode="numeric" placeholder="Ex.: 11987654321" required>

        <label for="senha">Senha</label>
        <input type="password" id="senha" placeholder="Mínimo 6 caracteres" required>

        <label for="confirmarSenha">Confirme sua senha</label>
        <input type="password" id="confirmarSenha" placeholder="Repita a senha" required>

        <label for="objetivo">Qual é seu objetivo?</label>
        <select id="objetivo">
          <option>Piloto Privado (PP)</option>
          <option>Piloto Comercial (PC)</option>
          <option>Comissário (CMS)</option>
          <option>Mecânico de Manutenção de Aeronaves (MMA)</option>
          <option>Outro</option>
        </select>

        <label for="fase">Em qual fase de estudo você está?</label>
        <select id="fase">
          <option>Fase Teórica</option>
          <option>Fase Prática</option>
          <option>Já sou habilitado</option>
          <option>Estou começando agora</option>
        </select>

        <button id="btnCadastrar" type="submit" class="btn">Cadastrar</button>
        <div id="mensagem" class="mensagem" aria-live="polite"></div>
      </form>

      <a class="voltar" href="quiz.html">← Voltar para o login</a>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { 
      getAuth, 
      createUserWithEmailAndPassword, 
      deleteUser,
      signOut 
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    // ⚙️ Config do seu projeto
    const firebaseConfig = {
      apiKey: "AIzaSyCZcJS_AQYPWcYRsnoWljBgZRItBrCO9DE",
      authDomain: "quiz-aviacao.firebaseapp.com",
      projectId: "quiz-aviacao",
      storageBucket: "quiz-aviacao.appspot.com",
      messagingSenderId: "304277871974",
      appId: "1:304277871974:web:98ebb69afe488439d53ca7",
      measurementId: "G-B9NBQJD8KC"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Validadores simples
    const validarCPF = (cpf) => /^\d{11}$/.test(cpf);
    const validarTelefone = (tel) => /^\d{10,11}$/.test(tel);
    const validarEmail = (em) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(em);

    const form = document.getElementById('cadastro-form');
    const btn = document.getElementById('btnCadastrar');
    const msg = document.getElementById('mensagem');

    function setMensagem(texto, tipo = "erro") {
      msg.textContent = texto;
      msg.className = `mensagem ${tipo}`;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      setMensagem("");
      btn.disabled = true;

      const nome = document.getElementById('nome').value.trim();
      const cpf = document.getElementById('cpf').value.trim();
      const email = document.getElementById('email').value.trim();
      const telefone = document.getElementById('telefone').value.trim();
      const senha = document.getElementById('senha').value;
      const confirmarSenha = document.getElementById('confirmarSenha').value;
      const objetivo = document.getElementById('objetivo').value;
      const fase = document.getElementById('fase').value;

      // Validações de front
      if (!nome)                         { setMensagem("Informe seu nome completo."); btn.disabled = false; return; }
      if (!validarCPF(cpf))              { setMensagem("CPF inválido. Deve conter 11 dígitos numéricos."); btn.disabled = false; return; }
      if (!validarEmail(email))          { setMensagem("Email inválido."); btn.disabled = false; return; }
      if (!validarTelefone(telefone))    { setMensagem("Telefone inválido. Use apenas números com DDD (10 ou 11 dígitos)."); btn.disabled = false; return; }
      if (senha.length < 6)              { setMensagem("A senha deve ter pelo menos 6 caracteres."); btn.disabled = false; return; }
      if (senha !== confirmarSenha)      { setMensagem("As senhas não coincidem."); btn.disabled = false; return; }

      let createdUser = null;

      try {
        // 1) Cria o usuário primeiro (garante request.auth nas regras)
        const cred = await createUserWithEmailAndPassword(auth, email, senha);
        createdUser = cred.user;

        // 2) Grava o perfil no Firestore (sem leitura prévia para evitar bloqueio de regras)
        await addDoc(collection(db, "usuarios"), {
          uid: createdUser.uid,
          nome,
          cpf,
          telefone,
          email,
          objetivo,
          fase,
          ativo: true,
          timestamp: serverTimestamp()
        });

        setMensagem("Usuário cadastrado com sucesso! Redirecionando…", "ok");
        setTimeout(() => { window.location.href = "quiz.html"; }, 800);

      } catch (err) {
        console.error(err);
        // Se já criou o usuário mas falhou ao gravar no Firestore, limpa para evitar "email in use" na próxima tentativa
        try { if (createdUser) await deleteUser(createdUser); } catch(_) {}
        try { await signOut(auth); } catch(_) {}

        let texto = "Erro ao cadastrar.";
        if (err.code === "auth/email-already-in-use") texto = "Este email já está em uso.";
        else if (err.code === "auth/invalid-email") texto = "Email inválido.";
        else if (err.code === "auth/weak-password") texto = "A senha é muito fraca (mínimo 6 caracteres).";
        else if (err.code === "permission-denied") texto = "Sem permissão para salvar os dados (verifique as regras do Firestore).";
        setMensagem(texto + (err.code ? " (" + err.code + ")" : ""), "erro");
        btn.disabled = false;
      }
    });
  </script>
  <!-- Rodapé com Fale Conosco + WhatsApp + Instagram -->
<div style="margin-top: 40px; display: flex; justify-content: center; gap: 12px; padding-bottom: 20px;">
  
  <!-- Botão Fale Conosco -->
  <button id="btn-faleconosco" title="Fale com a gente"
    onclick="window.open('faleconosco.html', '_blank')"
    style="
      background: var(--verde);
      color: #fff;
      border: none;
      border-radius: 20px;
      padding: 8px 16px;
      font-size: 0.9rem;
      font-weight: 600;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      cursor: pointer;
    ">
    Fale conosco
  </button>

  <!-- Botão WhatsApp -->
  <a id="btn-whatsapp" title="Fale via WhatsApp"
    href="https://wa.me/5561920052273" target="_blank"
    style="
      width: 42px;
      height: 42px;
      background: var(--verde);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      cursor: pointer;
      text-decoration: none;
      overflow: hidden;
    ">
    <img src="WhatsApp.svg" alt="WhatsApp" style="height: 60%; width: auto;" />
  </a>

  <!-- Botão Instagram -->
  <a id="btn-instagram" title="Visite nosso Instagram"
    href="https://www.instagram.com/questoesdeaviacao" target="_blank"
    style="
      width: 42px;
      height: 42px;
      background: var(--verde);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      cursor: pointer;
      text-decoration: none;
      overflow: hidden;
    ">
    <img src="instagram.svg" alt="Instagram" style="height: 60%; width: auto;" />
  </a>

</div>

</body>
</html>